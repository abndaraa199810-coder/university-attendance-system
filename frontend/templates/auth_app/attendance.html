<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Face Attendance</title>

    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            background: #f7f7f7; 
            padding-top: 40px;
        }

        video { 
            width: 420px; 
            border-radius: 12px; 
            border: 3px solid #333; 
            margin-top: 10px;
        }

        #status {
            margin-top: 25px;
            font-size: 24px;
            font-weight: bold;
            padding: 10px 20px;
            display: inline-block;
        }
    </style>
</head>

<body>

<h1>Face Attendance System</h1>

<!-- ÙƒØ§Ù…ÙŠØ±Ø§ -->
<video id="camera" autoplay playsinline></video>

<!-- Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… -->
<div id="status">â³ Waiting for camera...</div>

<script>
// ---------------------------------------------
// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ CSRF Token
// ---------------------------------------------
function getCookie(name) {
    let cookieValue = null;
    const cookies = document.cookie ? document.cookie.split(';') : [];

    for (let c of cookies) {
        c = c.trim();
        if (c.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(c.substring(name.length + 1));
            break;
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

const video = document.getElementById("camera");
const status = document.getElementById("status");

// ---------------------------------------------
// ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
// ---------------------------------------------
async function startCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        status.innerHTML = "ğŸ¥ Camera Active - Scanning...";
    } catch (error) {
        status.innerHTML = "âš  Unable to access camera!";
    }
}

startCamera();

// ---------------------------------------------
// Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
// ---------------------------------------------
function captureFrame() {
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    return canvas.toDataURL("image/jpeg");
}

// ---------------------------------------------
// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Django Ù„Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¬Ù‡
// ---------------------------------------------
async function scanFace() {
    const video = document.getElementById("camera");
    const canvas = document.createElement("canvas");
    const context = canvas.getContext("2d");

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    const imageBase64 = canvas.toDataURL("image/jpeg");

    try {
        let response = await fetch("/auth/recognize_face/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ image: imageBase64 })
        });

        let data = await response.json();
        console.log(data);

        const status = document.getElementById("status");

        if (data.success && data.recognized) {
            status.innerHTML = "âœ” ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨: " + data.name;
        } else if (data.success && !data.recognized) {
            status.innerHTML = "âŒ ÙˆØ¬Ù‡ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
        } else {
            status.innerHTML = "âš  Ø®Ø·Ø£: " + data.error;
        }

    } catch (error) {
        console.error(error);
        status.innerHTML = "âš  Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…";
    }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ¹Ø±Ù ÙƒÙ„ 2 Ø«Ø§Ù†ÙŠØ©
setInterval(scanFace, 2000);
</script>

</body>
</html>
