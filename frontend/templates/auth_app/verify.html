<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·Ø§Ù„Ø¨</title>
  <style>
    body { font-family: Arial; text-align: center; background: #f4f6f8; }
    video { border: 2px solid #333; border-radius: 8px; }
    select, button { padding: 8px; margin: 8px; font-size: 16px; }
    #result {
      margin-top: 20px; font-size: 18px; padding: 15px;
      width: 60%; margin-left: auto; margin-right: auto;
      border-radius: 6px; display: none;
    }
    .success { background: #e6fffa; color: #065f46; border: 1px solid #10b981; }
    .error { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
    .warning { background: #fff7ed; color: #9a3412; border: 1px solid #fb923c; }
    .muted { color: #666; font-size: 13px; margin-top: 6px; }
  </style>
</head>
<body>

<h2>Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙˆÙŠØ© Ø§Ù„Ø·Ø§Ù„Ø¨</h2>

<select id="room">
    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø¹Ø© --</option>
    {% for r in rooms %}
        <option value="{{ r.code }}">
            {{ r.name }} ({{ r.code }})
        </option>
    {% endfor %}
</select>

<div class="muted">Ø§Ø®ØªØ± Ø±Ù…Ø² Ø§Ù„Ù‚Ø§Ø¹Ø© (Room Code) Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>

<br>

<video id="video" width="400" height="300" autoplay></video>
<br><br>
<button id="btn">ØªØ­Ù‚Ù‚</button>

<div id="result"></div>

<canvas id="canvas" width="400" height="300" style="display:none;"></canvas>

<script>
  const DEVICE_KEY = "{{ DEVICE_KEY|escapejs }}";
  console.log("DEVICE_KEY FROM TEMPLATE =", DEVICE_KEY);

  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const resultDiv = document.getElementById("result");
  const roomSelect = document.getElementById("room");
  const btn = document.getElementById("btn");

  // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => video.srcObject = stream)
    .catch(() => alert("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ØŒ ØªØ£ÙƒØ¯ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ØªØµÙØ­"));

  function showResult(type, html) {
    resultDiv.style.display = "block";
    resultDiv.className = type;
    resultDiv.innerHTML = html;
  }

  async function verifyStudent() {
    const roomCode = roomSelect.value;
    if (!roomCode) {
      alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ø¹Ø© Ø£ÙˆÙ„Ù‹Ø§");
      return;
    }

    // Ø§Ù„ØªÙ‚Ø· ØµÙˆØ±Ø©
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = canvas.toDataURL("image/jpeg");

    try {
      const res = await fetch("/auth/verify/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-DEVICE-KEY": DEVICE_KEY
        },
        body: JSON.stringify({
          room_code: roomCode,
          image: imageData
        })
      });

      const data = await res.json();

      if (data.matched && data.authorized) {
        showResult("success", `
          âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­<br><br>
          <b>Ø§Ù„Ø§Ø³Ù…:</b> ${data.full_name}<br>
          <b>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ:</b> ${data.student_id}<br>
          ğŸ« <b>Ø§Ù„Ù‚Ø§Ø¹Ø©:</b> ${data.room}<br>
          ğŸ•’ <b>Ø§Ù„ÙˆÙ‚Øª:</b> ${data.time}<br>
          ğŸ“Œ <b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> ${data.status}<br>
          â­ <b>Ø§Ù„Ø«Ù‚Ø©:</b> ${data.confidence}
        `);
      } else if (data.matched && !data.authorized) {
        showResult("warning", `
          âš ï¸ ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„ÙƒÙ† ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ù‡<br><br>
          <small>Ø§Ù„Ø³Ø¨Ø¨: ${data.reason || "FORBIDDEN"}</small>
        `);
      } else {
        showResult("error", `âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨<br><small>${data.error || ""}</small>`);
      }

    } catch (e) {
      console.error(e);
      showResult("error", "âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…");
    }
  }

  btn.addEventListener("click", verifyStudent);
</script>

</body>
</html>
